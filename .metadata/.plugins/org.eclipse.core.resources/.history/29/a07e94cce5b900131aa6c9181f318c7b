package http.impl;

import java.io.File;
import java.io.IOException;

import http.Interfaces.IHttpHandler;
import http.Interfaces.IRequestHttpHandler;
import http.Interfaces.IResponseHttpHandler;

public class StaticHandler implements IHttpHandler {

	@Override
	public void execute(IRequestHttpHandler request, IResponseHttpHandler response) throws IOException {
		String path = request.getRealPath(request.getUrl());
		if(path != null)
		{
			File index = null;
			if((index = this.haveIndex(path)) != null)
			{
				FileInputStream fs = new FileInputStream(index);
				int n = 0;
				while((n = fs.read()) != -1)
				{
					response.getWriter().write(n);
				}
				fs.close();
			}
			else
			{
				File folder = new File(path);
				
				if(folder.isDirectory())
				{
					String complement = "";
					if(!request.getUrl().equals("/"))
						complement = request.getUrl();
					
					if(folder != null && folder.listFiles() != null)
					{
						response.getWriter().write("<a href=\"./\">.</a>");
						response.getWriter().write("<br />");
						response.getWriter().write("<a href=\"../\">..</a>");
						response.getWriter().write("<br />");
						for (File fileEntry : folder.listFiles()) 
						{
							response.getWriter().write("<a href=\""+complement+
									"/"+fileEntry.getName()+"\">"+fileEntry.getName()+"</a>");
							response.getWriter().write("<br />");
						}
					}
				}
				else if(folder.isFile())
				{
					String ext = FilenameUtils.getExtension(path);
					ext = ext.toLowerCase();
					if(ext.equals("jpg") || ext.equals("png") || ext.equals("gif"))
					{
						response.getWriter().write(this.beginHtml()+"<img src=\""+request.getHeader("Host")+request.getHeader("Url")+"\" />"+this.endHtml());
					}
				}
				else
				{
					response.getWriter().write("Hmm comment tes vous arrivŽ ici ?");
				}
			}
		}
		response.flush();
	}
	
	private String beginHtml()
	{
		return "<!DOCTYPE html><html><head></head><body>";
	}
	
	private String endHtml()
	{
		return "</body></html>";
	}
	
	private File haveIndex(String path)
	{
		File folder = new File(path);
		if(folder != null && folder.listFiles() != null)
		{
			for (File fileEntry : folder.listFiles()) 
			{
		        if (!fileEntry.isDirectory()) 
		        {
		           if(fileEntry.getName().equals("index.html"))
		        	   return fileEntry;
		        }
		    }
		}
		return null;
	}
}